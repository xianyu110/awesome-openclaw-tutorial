# 飞书定时任务故障排查补充内容

> 可补充到第6章或第15章

## 6.5 飞书定时任务故障排查

### 常见问题

使用OpenClaw的飞书定时任务功能时，可能会遇到以下问题：
- ✅ 定时任务创建成功，但到时间没有推送
- ✅ 推送失败，没有收到通知
- ✅ 时间不准确，提前或延后推送

本节将详细介绍如何排查和解决这些问题。

### 问题1：定时任务无效

#### 症状

```
我：每天早上9点给我推送AI资讯
OpenClaw：好的，已设置定时任务
（到了9点，没有任何推送）
```

#### 排查步骤

##### 1. 检查服务器时区

**问题原因**：服务器时区不是北京时间，导致定时任务时间错乱。

**检查方法**：

```bash
# 查看当前时区
date
timedatectl

# 应该显示类似：
# Time zone: Asia/Shanghai (CST, +0800)
```

**解决方法**：

```bash
# 设置时区为上海（北京时间）
sudo timedatectl set-timezone Asia/Shanghai

# 或者
sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

# 验证
date
```

![时区配置](https://upload.maynor1024.live/file/1770782735745_image_22.jpg)

##### 2. 检查飞书机器人权限

**问题原因**：飞书机器人权限不足，无法发送消息。

**必需权限清单**：

在飞书开放平台配置以下权限：

- ✅ `im:message` - 发送消息
- ✅ `im:message:send_as_bot` - 以机器人身份发送消息
- ✅ `im:chat` - 获取群组信息
- ✅ `im:chat:readonly` - 读取群组信息

**配置步骤**：

1. 登录飞书开放平台：https://open.feishu.cn/
2. 进入你的应用
3. 点击「权限管理」
4. 搜索并开启上述权限
5. 点击「发布版本」使权限生效

![飞书权限配置](https://upload.maynor1024.live/file/1770782736252_image_23.jpg)

**验证方法**：

OpenClaw通常会主动提示缺少哪些权限：

```
OpenClaw：检测到缺少以下权限：
- im:message:send_as_bot
请在飞书开放平台添加这些权限
```

##### 3. 记录飞书用户ID

**问题原因**：OpenClaw不知道要给谁发送通知。

**解决方法**：

让OpenClaw记录你的飞书ID：

```
我：记住我的飞书ID
OpenClaw：好的，已记录你的飞书ID：ou_xxx
```

或者手动告诉OpenClaw：

```
我：我的飞书ID是 ou_xxx，记住它
OpenClaw：好的，已记录
```

**获取飞书ID的方法**：

方法1：让OpenClaw告诉你

```
我：我的飞书ID是什么？
OpenClaw：你的飞书ID是：ou_xxx
```

方法2：在飞书开放平台查看

1. 进入飞书开放平台
2. 点击「开发文档」->「服务端API」->「通讯录」
3. 使用「获取用户信息」接口查询

![飞书ID获取](https://upload.maynor1024.live/file/1770782741678_image_24.jpg)

### 问题2：推送时间不准确

#### 症状

```
我：每天早上9点推送
（实际8点就推送了，或者10点才推送）
```

#### 排查步骤

##### 1. 确认时区设置

参考上面的「检查服务器时区」步骤。

##### 2. 检查定时任务配置

查看OpenClaw的定时任务配置：

```bash
# 查看cron任务
crontab -l

# 或查看OpenClaw的任务配置
cat ~/.openclaw/tasks.json
```

##### 3. 使用明确的时间表达

避免模糊的时间表达，使用明确的时间：

❌ 不好的表达：
```
早上给我推送
明天提醒我
```

✅ 好的表达：
```
每天早上9:00给我推送
明天下午3:30提醒我
2026年2月15日上午10:00提醒我
```

### 问题3：推送内容为空或错误

#### 症状

```
（收到推送，但内容是空的或者是错误信息）
```

#### 排查步骤

##### 1. 检查Skills是否安装

如果定时任务需要使用某个Skill（如百度搜索），确保已安装：

```
我：列出已安装的Skills
OpenClaw：已安装的Skills：
- web_search
- file_manager
...
```

如果缺少，安装对应的Skill：

```
我：安装百度搜索Skill
```

##### 2. 检查API配额

某些Skill需要API调用，可能配额用完了：

```bash
# 查看API使用情况
# 登录对应的服务商平台查看
```

##### 3. 查看错误日志

```bash
# 查看OpenClaw日志
tail -f ~/.openclaw/logs/openclaw.log

# 或
journalctl -u openclaw -f
```

### 完整的定时任务配置示例

#### 示例1：每天早报

```
我：每天早上9:00，搜索"AI行业最新动态"，总结成5条要点，发送给我

OpenClaw：好的，已设置定时任务：
- 时间：每天 09:00
- 任务：搜索AI行业动态并总结
- 推送对象：你（ou_xxx）
```

![定时任务示例](https://upload.maynor1024.live/file/1770782748595_image_25.jpg)

#### 示例2：监控特定信息

```
我：每天凌晨2:00，检查Claude官网是否有新版本发布，如果有，早上8:00通知我

OpenClaw：好的，已设置：
- 检查时间：每天 02:00
- 通知时间：如有更新，08:00 通知
```

![监控任务](https://upload.maynor1024.live/file/1770782753487_image_26.jpg)

#### 示例3：群组推送

```
我：每周一早上9:00，在"技术讨论群"发送本周技术热点

OpenClaw：好的，已设置：
- 时间：每周一 09:00
- 推送位置：技术讨论群
- 内容：本周技术热点总结
```

### 调试技巧

#### 1. 先测试手动执行

在设置定时任务前，先手动测试一次：

```
我：搜索"AI行业最新动态"，总结成5条要点
（确认功能正常）

我：好的，那每天早上9点自动执行这个任务
```

#### 2. 使用短时间间隔测试

测试时使用短时间间隔，避免等待太久：

```
我：5分钟后给我推送一条测试消息
（等待5分钟，验证是否收到）

我：好的，那改成每天早上9点
```

#### 3. 查看任务列表

随时查看已设置的定时任务：

```
我：列出所有定时任务
OpenClaw：当前定时任务：
1. 每天 09:00 - AI资讯推送
2. 每周一 09:00 - 周报推送
3. 每天 02:00 - 网站监控
```

#### 4. 修改或删除任务

```
我：删除AI资讯推送任务
OpenClaw：已删除

我：修改周报推送时间为每周一10:00
OpenClaw：已修改
```

### 最佳实践

#### 1. 明确的任务描述

✅ 好的描述：
```
每天早上9:00，使用百度搜索Skill搜索"AI行业动态"，
提取最重要的5条新闻，每条包含标题、来源、简介，
以飞书消息卡片形式发送给我
```

❌ 不好的描述：
```
早上给我推送AI新闻
```

#### 2. 合理的推送频率

避免过于频繁的推送，造成打扰：

- ✅ 每天1-2次
- ✅ 每周1-2次
- ❌ 每小时1次
- ❌ 每10分钟1次

#### 3. 错峰推送

避免所有任务都在同一时间执行：

```
任务1：09:00 - AI资讯
任务2：09:30 - 行业报告
任务3：10:00 - 竞品分析
```

#### 4. 设置失败重试

```
我：如果推送失败，10分钟后重试一次
```

### 故障排查清单

遇到问题时，按以下清单逐项检查：

- [ ] 服务器时区是否为 Asia/Shanghai
- [ ] 飞书机器人权限是否完整
- [ ] 飞书用户ID是否已记录
- [ ] 所需Skills是否已安装
- [ ] API配额是否充足
- [ ] 任务描述是否明确
- [ ] 时间表达是否准确
- [ ] 网络连接是否正常
- [ ] OpenClaw服务是否运行中

### 获取帮助

如果以上方法都无法解决问题：

1. 查看OpenClaw日志：
   ```bash
   tail -100 ~/.openclaw/logs/openclaw.log
   ```

2. 在GitHub提Issue：
   https://github.com/openclaw/openclaw/issues

3. 加入社区讨论：
   - OpenClaw官方Discord
   - 飞书用户交流群

4. 查看官方文档：
   https://docs.openclaw.ai

### 相关章节

- [第6章：日程与任务管理](06-schedule-management.md)
- [第9章：多平台集成](../03-advanced/09-multi-platform-integration.md)
- [第15章：常见问题与解决](../05-troubleshooting/15-common-problems.md)

---

## 总结

飞书定时任务的三个关键点：
1. ⏰ **时区配置**：确保服务器时区为北京时间
2. 🔑 **权限配置**：确保飞书机器人有足够权限
3. 👤 **用户ID**：确保OpenClaw知道推送给谁

只要这三点配置正确，定时任务就能稳定运行！
